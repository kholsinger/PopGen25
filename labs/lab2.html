<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lab 2 – EEB5348-Fall25</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f1ee3210ae63f1ea454c627e8e4588eb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">EEB5348-Fall25</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notes.html"> 
<span class="menu-text">Useful links</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../labs.html"> 
<span class="menu-text">Labs</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-structures-in-genomics" id="toc-data-structures-in-genomics" class="nav-link active" data-scroll-target="#data-structures-in-genomics">Data structures in genomics</a>
  <ul class="collapse">
  <li><a href="#for-this-class" id="toc-for-this-class" class="nav-link" data-scroll-target="#for-this-class">For this class:</a>
  <ul class="collapse">
  <li><a href="#a-note-on-version-control-with-git" id="toc-a-note-on-version-control-with-git" class="nav-link" data-scroll-target="#a-note-on-version-control-with-git">A note on version control with git</a></li>
  </ul></li>
  <li><a href="#virtual-environments-and-package-management" id="toc-virtual-environments-and-package-management" class="nav-link" data-scroll-target="#virtual-environments-and-package-management">Virtual environments and package management</a>
  <ul class="collapse">
  <li><a href="#r-renv" id="toc-r-renv" class="nav-link" data-scroll-target="#r-renv">R: <code>renv</code></a></li>
  <li><a href="#julia-package-environments" id="toc-julia-package-environments" class="nav-link" data-scroll-target="#julia-package-environments">Julia: package environments</a></li>
  <li><a href="#python-conda" id="toc-python-conda" class="nav-link" data-scroll-target="#python-conda">Python: <code>conda</code></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#buffalo-2021-data" id="toc-buffalo-2021-data" class="nav-link" data-scroll-target="#buffalo-2021-data">Buffalo 2021 data:</a>
  <ul class="collapse">
  <li><a href="#data-formats-90-of-the-battle" id="toc-data-formats-90-of-the-battle" class="nav-link" data-scroll-target="#data-formats-90-of-the-battle">Data formats: 90% of the battle</a></li>
  <li><a href="#looking-at-the-data-before-importing-it" id="toc-looking-at-the-data-before-importing-it" class="nav-link" data-scroll-target="#looking-at-the-data-before-importing-it">Looking at the data before importing it</a></li>
  <li><a href="#r" id="toc-r" class="nav-link" data-scroll-target="#r">R</a></li>
  <li><a href="#julia" id="toc-julia" class="nav-link" data-scroll-target="#julia">Julia</a></li>
  <li><a href="#re-creating-the-main-plot-in-buffalo-2021" id="toc-re-creating-the-main-plot-in-buffalo-2021" class="nav-link" data-scroll-target="#re-creating-the-main-plot-in-buffalo-2021">Re-creating the main plot in Buffalo 2021</a></li>
  <li><a href="#plotting-in-r" id="toc-plotting-in-r" class="nav-link" data-scroll-target="#plotting-in-r">Plotting in <code>R</code></a></li>
  <li><a href="#plotting-in-julia" id="toc-plotting-in-julia" class="nav-link" data-scroll-target="#plotting-in-julia">Plotting in <code>Julia</code></a></li>
  </ul></li>
  <li><a href="#genomic-data-formats" id="toc-genomic-data-formats" class="nav-link" data-scroll-target="#genomic-data-formats">Genomic data formats</a>
  <ul class="collapse">
  <li><a href="#how-is-a-vcf-file-structured" id="toc-how-is-a-vcf-file-structured" class="nav-link" data-scroll-target="#how-is-a-vcf-file-structured">How is a VCF file structured</a>
  <ul class="collapse">
  <li><a href="#headers" id="toc-headers" class="nav-link" data-scroll-target="#headers">Header(s)</a></li>
  </ul></li>
  <li><a href="#genotype-information" id="toc-genotype-information" class="nav-link" data-scroll-target="#genotype-information">Genotype information</a></li>
  <li><a href="#reading-in-vcf-data" id="toc-reading-in-vcf-data" class="nav-link" data-scroll-target="#reading-in-vcf-data">Reading in VCF data</a></li>
  <li><a href="#julia-solution" id="toc-julia-solution" class="nav-link" data-scroll-target="#julia-solution">Julia solution</a></li>
  <li><a href="#bonus-plot-your-heterozygosities" id="toc-bonus-plot-your-heterozygosities" class="nav-link" data-scroll-target="#bonus-plot-your-heterozygosities">Bonus: Plot your heterozygosities</a></li>
  </ul></li>
  <li><a href="#why-do-i-need-to-write-my-own-code-for-heterozygosity-isnt-there-software-for-this" id="toc-why-do-i-need-to-write-my-own-code-for-heterozygosity-isnt-there-software-for-this" class="nav-link" data-scroll-target="#why-do-i-need-to-write-my-own-code-for-heterozygosity-isnt-there-software-for-this">Why do I need to write my own code for heterozygosity? Isn’t there software for this?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 2</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="data-structures-in-genomics" class="level1">
<h1>Data structures in genomics</h1>
<p>Today’s goal is two-fold:</p>
<ol type="1">
<li><p>Learn to import and manipulate data tables either in <code>R</code> or <code>Julia</code>.</p></li>
<li><p>Understand how genomic data files are structured, and play around with one.</p></li>
</ol>
<p>I will supply both <code>Julia</code> and <code>R</code> code in the blocks below - it’s up to you which you use. However, in either case I would recommend using some kind of IDE (integrated development environment). An IDE lets you interact with a programming language by seperating out your code writing from your code execution, and generally supplies lots of convenience functions. If you’ve already been using <code>R</code>, you are likely already using an IDE: <code>RStudio</code> (and if not, <a href="https://posit.co/download/rstudio-desktop/">try it</a> or <a href="https://positron.posit.co/download.html">positron</a> which is meant to replace it long run). <code>Pluto</code> actually functions as a lightweight IDE for <code>Julia</code>, but if you would like more bells and whistles, I will recommend some branch of <code>VSCode</code>, like <a href="https://vscodium.com/">VSCodium</a>. Setting it up should take you a few moments, but I am happy to help out.</p>
<p>Before we start coding, whichever language/IDE you have chosen, let’s think about how you’ll organize code. If you have done coding in the past, you are probably used to <em>everything</em> you write for a single project living in a single file. You are also therefore probably used to having to scroll gigantic files trying to find where some small piece of code is. More troublingly, if you have to redo something multiple times (say, loop through some function for different subsets of data), you probably have to remember to edit each instance of doing that method when you change it. I’ll try to encourage you to write code in a way that is more modular: functions/approaches you reuse can live in a separate file, so that you can quickly find them, and edit them more consistently.</p>
<p>In the case of my own projects, I organize them in a way that lets me reuse code, and edit it more consistently, by taking some pointers from the software development world. A typical project directory for me looks like:</p>
<pre><code>project
|    README.md
|____data/
|    |_____raw_data.tsv
|    |_____genomic.vcf
|____scripts/
|____results/
|____src/
|    |____genomic_functions.jl
|    |____stats_functions.jl
|    |____plotting_functions.jl
|     
|____plots/</code></pre>
<p>Unprocessed data files can live in the <code>data/</code> folder, letting you avoid editing them by accident and overwriting raw data. Scripts/pipelines to process the data go in <code>scripts/</code>, processed data that you don’t want to regenerate/results tables go in <code>results/</code>, and most importantly, any custom code goes into <code>src/</code>.</p>
<section id="for-this-class" class="level2">
<h2 class="anchored" data-anchor-id="for-this-class">For this class:</h2>
<p>Try working in the directory structure that you’ve been given with this repository. There is a folder including some <code>Julia</code> code I’ve written in <code>src/</code> , and over time it will be populated with more of my own solutions, but you might as well add your own. To avoid <code>git</code> issues when you pull code in future weeks (and later help me when I’m grading code submissions), create a file in <code>src/</code> called <code>last_name.R</code> or <code>last_name.jl</code>, depending on whether you are writing in <code>R</code> or <code>Julia</code>, respectively. Any <em>functions</em> you write - try to keep them in that file. Any scripts you work on for labs can live in the <code>labs</code> folder, just call them <code>lab_{number of lab}_{last name}.R</code> or <code>.jl</code> or <code>.sh</code> or whatever other format.</p>
<section id="a-note-on-version-control-with-git" class="level3">
<h3 class="anchored" data-anchor-id="a-note-on-version-control-with-git">A note on version control with git</h3>
<p>Some of you are probably already used to using <code>git</code>. For others this might be an entirely new thing. I will not be enforcing, but I do strongly recommend you start getting acquainted with it - it will save you many headaches in the long run. <a href="https://swcarpentry.github.io/git-novice/">Check out this guide</a> for a place to start.</p>
</section>
</section>
<section id="virtual-environments-and-package-management" class="level2">
<h2 class="anchored" data-anchor-id="virtual-environments-and-package-management">Virtual environments and package management</h2>
<p>In different projects, you’ll often use different sets of software packages/libraries for your programming language. To make your workflow fully replicable, it’s a good idea to keep track of the package environment with some sort of environment management approach. Even if you are not worried about reporting your results eventually in a paper and having the correct package versions listed, consider a common work case: you run a script on your laptop and it runs <em>fine</em>. You then try to run it on data on the cluster, and it breaks: turns out a slightly different package version no longer behaves the way it does on your laptop - but you don’t know that! Looking for help, you then go to send your code to your PI, and they cannot get it running either. So, a result you thought you had gets tossed because you assume you made a mistake <em>somewhere</em>, just not sure where. This can all be avoided by using virtual environments - when you send your code to the cluster, it should include a manifest of each package required AND its version. Same for when you send it to your PI.</p>
<p>You don’t need to do this right now, but feel free to come back to this section after you’ve run through the lab and figure out what virtual environment works for you.</p>
<section id="r-renv" class="level3">
<h3 class="anchored" data-anchor-id="r-renv">R: <code>renv</code></h3>
<p><code>renv</code> is the best approach to manage your packages in <code>R</code>. Getting it set up is relatively easy, and <code>Rstudio</code> comes with some utility tools for it. Follow the guide <a href="https://rstudio.github.io/renv/">here</a>.</p>
<p>In my personal experience, <code>R</code> ends up with frequent weird issues with packages, where some version of some library requires a new version of <code>R</code>, while a different package is not yet updated and therefore incompatible. For that (and other reasons we can talk about), I will recommend that you avoid looking for packages that do some task for you, and write your own code for it when possible, at least for this class.</p>
</section>
<section id="julia-package-environments" class="level3">
<h3 class="anchored" data-anchor-id="julia-package-environments">Julia: package environments</h3>
<p><code>Julia</code> has package environments built into its core, so there’s nothing too special you need to do. If you are working using a <code>Pluto</code> notebook, for instance, the package environment is handled entirely for you. But as you probably noticed in last weeks lab - the startup time includes a whole lot of precompiling packages in the background. The way to make <code>Julia</code> quite a bit faster is to explicitly have a project file in your project directory. You do this as follows:</p>
<div id="2" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg;</span> Pkg.activate("/absolute/path/to/your/project/"); Pkg.instantiate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What the above line will do is tell <code>Julia</code> to create two files in the project directory: <code>Manifest.toml</code> and <code>Project.toml</code>. These files just keep track of the versions of all of the packages that have been added to the project, so that when you start up the project, it knows there should be stored binaries for all of those packages (compatible with each other). As you add new packages, it’ll handle downgrading/upgrading/finding a solution that works for all of the packages you want.</p>
</section>
<section id="python-conda" class="level3">
<h3 class="anchored" data-anchor-id="python-conda">Python: <code>conda</code></h3>
<p>Python has a few solutions, but probably the best is making a <code>conda</code> environment. It builds on top of python’s own system <code>pip</code> and <code>pyenv</code>, but has great integration with the huge ecosystem of packages that exist in the <code>Python</code> world. See a guide <a href="https://carpentries-incubator.github.io/introduction-to-conda-for-data-scientists/01-getting-started-with-conda/index.html">here</a>.</p>
</section>
</section>
</section>
<section id="buffalo-2021-data" class="level1">
<h1>Buffalo 2021 data:</h1>
<p>The first thing we’ll do is learn how to import data/deal with data frames in either <code>R</code> or <code>Julia</code>.</p>
<section id="data-formats-90-of-the-battle" class="level2">
<h2 class="anchored" data-anchor-id="data-formats-90-of-the-battle">Data formats: 90% of the battle</h2>
<p>You will find that in practice most bioinformatics is wrangling data formats. Every piece of software/software package has its own preferred format for data. This is part of the reason I stress the importance of understanding (and being able to write your own) code for performing various population genetic approaches. If you know how to calculate <span class="math inline">\(\pi\)</span>, you will hopefully just figure out how to do that for the format you have the data in, rather than having to spend hours/days chasing format conversion down. In this and future weeks, I will give you a general run down of what you need to do with the data, and then give you some code/pointers as for how, but I’ll leave the actual implementation to you.</p>
</section>
<section id="looking-at-the-data-before-importing-it" class="level2">
<h2 class="anchored" data-anchor-id="looking-at-the-data-before-importing-it">Looking at the data before importing it</h2>
<p>It’s useful to take a glance at the data before you try to import it. You can try to open the file using your operating system’s choice of software, but Unix tools are built well to precisely do a quick glance. In the <code>labs/data</code> folder, there is a file called <code>buffalo.txt</code>. This is the data from <span class="citation" data-cites="Buffalo2021">(<a href="#ref-Buffalo2021" role="doc-biblioref">Buffalo 2021</a>)</span>. Before you import it, it’s good to take a look at what the data actually looks like. We can do so in the terminal. Navigate to the right directory (if you are on Windows and using <code>wsl</code>, I can help you here). Once there, run the following</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> buffalo.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see something like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">species</span> phylum  habitat mating_system   range_cat       sexual_system   abbrv   neut_model_conf genome_species self_est maplen_data_source      diversity_data_source   site_type       hcn     num_markers     parpath pred_piimpact_of_sel    log10_size      log10_range     num_chr totalMb_covered ave_rec assembly_size   selfing map_length      genome_size     fecundity       propagule       bodymass_g      diversity       size    log10_diversitysocial   species_orig    is_terrestrial  n_occ   range   id      kingdom superphylum     subphylum       class  order    family  genus   clean_name      redlist_cat     log10_body_mass log10_body_mass_pred    log10_popsize  log10_density    log10_density_pred      pred_log10_body_mass    pred_log10_density      pred_log10_N    RS     log10_RS log10_map_length        species_lower</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Abatus</span> agassizi Echinodermata   NA      NA      NA      NA      NA      NA      NA      NA      NA      Romiguier et al.        NA      NA      NA      FALSE   NA      NA      <span class="at">-1.6108339156354674</span>     6.633700542517746      NA       NA      NA      NA      NA      NA      NA      0.299   0.002   9.28    0.00727197      0.0245  <span class="at">-2.1383479214336867</span>     FALSE   Abatus agassizi FALSE   72      4302298.533787006       NA      Animalia        NA     NA       Echinoidea      Spatangoida     Schizasteridae  Abatus  Abatus agassizi NA      <span class="at">-0.6534814211608199</span>    <span class="at">-0.6405066270384477</span>      11.065298198284022      4.431597655766276       4.42625265103009        <span class="at">-0.6547028847549656</span>     4.432901908737623       11.066602451255369      175604021.7872247       8.244534458153213       NA     abatus agassizi</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Acromyrmex</span> echinatior   Arthropoda      NA      NA      NA      male.haploid    NA      NA      NA      NA     Stapley et al.   NA      NA      19      145     FALSE   NA      NA      <span class="at">-2.2596373105057563</span>     5.61732386966055NA      NA      NA      NA      NA      20.338  0.335   NA      NA      NA      NA      0.0055  NA      TRUE   Acromyrmex echinatior    TRUE    105     414308.5250288181       574019  Animalia        Ecdysozoa       HexapodaInsecta Hymenoptera     Formicidae      Acromyrmex      Acromyrmex echinatior   NA      <span class="at">-2.7280036542040085</span>    <span class="at">-2.7364907216649312</span>      11.617818883879833      6.000495014219284       6.009905730795794       <span class="at">-2.7309804876823183</span>     6.003335452336658       11.620659321997207      75328822.73251238       7.8769611801663055      1.3083082429982256      acromyrmex echinatior</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Acropora</span> millepora      Cnidaria        NA      NA      NA      hermaphrodite   NA      NA      NA      NA     Stapley et al.   NA      NA      14      429     FALSE   NA      NA      NA      7.795297039711985       NA     NA       NA      NA      NA      13.91   0.42    NA      NA      NA      NA      NA      NA      FALSE   Acropora millepora      FALSE   1613    62416159.05944288       52901   Animalia        NA      Anthozoa        AnthozoaScleractinia    Acroporidae     Acropora        Acropora millepora      NT      NA      NA      NA      NA     NA       NA      NA      NA      NA      NA      1.1433271299920464      acropora millepora</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Acyrthosiphon</span> pisum     Arthropoda      Terrestrial     Partial selfing Cosmopolitan    parthenogenic   NA     NA       NA      NA      Stapley et al.  Leffler et al.  NA      5       173     FALSE   NA      NA      <span class="at">-2.3979400086720375</span>     7.080809415567688       NA      NA      NA      NA      NA      3.94    0.165   NA      NA     NA       0.0088125       0.004   <span class="at">-2.054900870000545</span>      FALSE   Acyrthosiphon pisum     TRUE    2512    12045072.421827307      200572  Animalia        Ecdysozoa       Hexapoda        Insecta Hemiptera       Aphididae      Acyrthosiphon    Acyrthosiphon pisum     NA      <span class="at">-3.1702208566789927</span>     <span class="at">-3.182279811406018</span>      13.415739698676683      6.334930283108995       6.357104023822486       <span class="at">-3.173571874992307</span>      6.338098183370152       13.41890759893784       3011268105.4568267      9.478749424239727       0.5954962218255742      acyrthosiphon pisum</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Aedes</span> aegypti   Arthropoda      Terrestrial     Obligatory outcrossing  Cosmopolitan    gonochorous     NA     NA       NA      NA      Stapley et al.  Leffler et al.  NA      3       2006    FALSE   NA      NA      <span class="at">-2.579631620142476</span>      7.583115518888759       NA      NA      NA      NA      NA      2.35    0.94214 NA      NA     NA       0.01421 0.0026325       <span class="at">-1.8474059220725303</span>     FALSE   Aedes aegypti   TRUE    30000   38292658.52071776       126240  Animalia        Ecdysozoa       Hexapoda        Insecta Diptera Culicidae       Aedes   Aedes aegypti   NA      <span class="at">-3.7511723290864785</span>     <span class="at">-3.753271310092434</span>      14.35740153216626       6.774286013277501      6.770873848375246        <span class="at">-3.7550149230997683</span>     6.777884108505123       14.360999627393882      14546119096.189085      10.162747139031236      0.37106786227173627     aedes aegypti</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Aedes</span> albopictus        Arthropoda      NA      NA      NA      gonochorous     NA      NA      NA      NA     Stapley et al.   NA      NA      3       172     FALSE   NA      NA      <span class="at">-2.580044251510242</span>      7.445784591347202       NA      NA      NA      NA      NA      2.126   1.09047 NA      NA      NA      NA      0.00263 NA     FALSE    Aedes albopictus        TRUE    30000   27911590.92003886       126244  Animalia        Ecdysozoa      Hexapoda Insecta Diptera Culicidae       Aedes   Aedes albopictus        NA      <span class="at">-3.7524917009535947</span>     <span class="at">-3.753551590575262</span>      14.221068404987681      6.775283813640479       6.779607141395379       <span class="at">-3.756335411361592</span>     6.778882885863879        14.224667477211081      10612772212.942533      10.025828842857445      0.32756326018727794     aedes albopictus</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Agelaius</span> phoeniceus     Chordata        Terrestrial     Obligatory outcrossing  Broad endemic   NA      NA     NA       NA      NA      NA      Leffler et al.  NA      NA      NA      FALSE   NA      NA      <span class="at">-0.6575773191777937</span>     7.119596489010348       NA      NA      NA      NA      NA      NA      NA      NA      NA      NA     0.0059   0.22    <span class="at">-2.2291479883578558</span>     FALSE   Agelaius phoeniceus     TRUE    30000   13170324.908019817     179045   Animalia        NA      Vertebrata      Aves    Passeriformes   Icteridae       Agelaius        Agelaius phoeniceus     LC      2.394517431468307       2.39143600201306        9.246086360300021       2.126489871289673       2.117521308655038       2.3958750510517968      2.125537079006005       9.245133568016353       59865113.218271896      7.7771738081881425      NA      agelaius phoeniceus</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Ailuropoda</span> melanoleuca  Chordata        Terrestrial     Obligatory outcrossing  Narrow endemic  NA      NA     NA       NA      NA      NA      Leffler et al.  NA      NA      NA      FALSE   NA      NA      0.18730634078622424     6.150386149916167       NA      NA      NA      NA      NA      NA      NA      NA      NA      NA     0.00135  1.53924 <span class="at">-2.869666231504994</span>      FALSE   Ailuropoda melanoleuca  TRUE    130     1413794.051074382      621845   Animalia        NA      Vertebrata      Mammalia        Carnivora       Ursidae Ailuropoda      Ailuropoda melanoleuca  VU      5.095998266476374       5.1000064327850865      6.2338291555483885      0.08344300563222148     0.08933867763248815     5.099641760862692       0.08048976492485682     6.2308759148410235      918501.3715043671       5.963079809129942       NA      ailuropoda melanoleuca</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Allolobophora</span> chlorotica        Annelida        NA      NA      NA      NA      NA      NA      NA      NA     NA       Romiguier et al.        NA      NA      NA      FALSE   NA      NA      <span class="at">-1.2596373105057561</span>     6.580581413049396       NA      NA      NA      NA      NA      NA      NA      0.74    2.38e-4 0.3     0.0449719      0.055    <span class="at">-1.3470587637088103</span>     FALSE   Allolobophora chlorotica        TRUE    3070    3806987.16874359       974862   Animalia        Lophozoa        NA      Clitellata      Opisthopora     Lumbricidae     Allolobophora  Allolobophora chlorotica NA      0.46945531325089346     0.4661403969117158      10.162936554916952      3.582355141867555       3.582435448831861       0.4691840295555272      3.5828278594116822      10.163409272461077     69217948.52261072        7.840218723555152       NA      allolobophora chlorotica</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ex">adagilis@4ZMQ374:/mnt/c/Projects/PopGen25/labs/data$</span> head <span class="at">-2</span> buffalo_2021.txt </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">species</span> phylum  habitat mating_system   range_cat       sexual_system   abbrv   neut_model_conf genome_species self_est maplen_data_source      diversity_data_source   site_type       hcn     num_markers     parpath pred_piimpact_of_sel    log10_size      log10_range     num_chr totalMb_covered ave_rec assembly_size   selfing map_length      genome_size     fecundity       propagule       bodymass_g      diversity       size    log10_diversitysocial   species_orig    is_terrestrial  n_occ   range   id      kingdom superphylum     subphylum       class  order    family  genus   clean_name      redlist_cat     log10_body_mass log10_body_mass_pred    log10_popsize  log10_density    log10_density_pred      pred_log10_body_mass    pred_log10_density      pred_log10_N    RS     log10_RS log10_map_length        species_lower</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Abatus</span> agassizi Echinodermata   NA      NA      NA      NA      NA      NA      NA      NA      NA      Romiguier et al.        NA      NA      NA      FALSE   NA      NA      <span class="at">-1.6108339156354674</span>     6.633700542517746      NA       NA      NA      NA      NA      NA      NA      0.299   0.002   9.28    0.00727197      0.0245  <span class="at">-2.1383479214336867</span>     FALSE   Abatus agassizi FALSE   72      4302298.533787006       NA      Animalia        NA     NA       Echinoidea      Spatangoida     Schizasteridae  Abatus  Abatus agassizi NA      <span class="at">-0.6534814211608199</span>    <span class="at">-0.6405066270384477</span>      11.065298198284022      4.431597655766276       4.42625265103009        <span class="at">-0.6547028847549656</span>     4.432901908737623       11.066602451255369      175604021.7872247       8.244534458153213       NA     abatus agassizi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This looks like a tab seperated file (usually ending in .tsv). Tabs are special characters (often denoted as <code>\t</code>) are one of the two most common ways to delimit fields in the data. Many data files adopt a general structure typical to .tsv files:</p>
<p>1) The first line is a header - indicating the names of the columns of data.</p>
<p>2) The data is often organized as a <em>wide</em> data format: each row represents a single data point, including all of its metadata. Long data formats will separate out the metadata. This can be sometimes useful when the data is sparse (lots of missing values) as it is in this dataset, but it is harder to parse for humans at a glance.</p>
<p>There are various packages/approaches to reading in data in most programming languages. The ones I’ll recommend for <code>R</code> and <code>Julia</code> focus on making the user’s life as simple as possible while catching <em>most</em> exceptions.</p>
</section>
<section id="r" class="level2">
<h2 class="anchored" data-anchor-id="r">R</h2>
<p>If you are working in <code>R</code>, open up your IDE and create a new file that you’ll store the commands you wrote here in. If you are using <code>RStudio</code>, consider creating a new R Markdown document. This is similar to the format this webpage is written in, with a mixture of text and executable code. Having good comments around what you’ve done is very helpful in the long run, so some form of Markdown can be great. Your screen should look something like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-09-03 102539.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>You’ll run code in the bottom left, and keep versions that ran/worked how you wanted in the top right.</p>
<p><code>R</code> has a variety of libraries to read in data. <code>readr</code> is the one I will recommend, because it does a good job of automatically detecting various idiosyncracies in the data. To read the datafile in with <code>readr</code>, you’ll need to run the following:</p>
<div id="4" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(readr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>buffalo_data <span class="op">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"&lt;path to your repository&gt;/labs/data/buffalo_2021.txt"</span>,sep<span class="op">=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will read the data in as a <code>tibble</code> object that is easy to work with in <code>R</code>. If you get an error stating the package does not exist, you ned to first install it. This can be done by running <code>install.packages("readr")</code>. You’ll then need to rerun the above block of code.</p>
</section>
<section id="julia" class="level2">
<h2 class="anchored" data-anchor-id="julia">Julia</h2>
<p>So, you’ve chosen <code>Julia</code>! If you are using <code>Pluto</code> as your coding environment, starting out will be as simple as creating a new Pluto notebook, and you can begin coding. If you are using VSCodium (or one of its branches), there’ll be a bit more setup in getting some <code>Julia</code> extensions installed, and figuring out the oh-so-many options that Virtual Studio tosses at you. But once you do, open the folder for this repository, and create a new <code>.jl</code> file somewhere and you can start coding. I recommend opening this repository only because you’ll then be able to piggyback off of the package environment for the course (which already has a bunch of packages you’ll probably want/need).</p>
<p>The way to activate that environment (assuming you run julia from the repository folder) is to open <code>Julia</code> and then hit the <code>]</code> key. This will enter you into <code>Pkg</code> mode (the line should start with <code>Pkg&gt;</code>. Then type:</p>
<div id="6" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>activate <span class="st">"PopGen25"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>instantiate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And all of the necessary packages should be installed and precompiled. Hit the backspace key to exit <code>Pkg</code> mode (the terminal should start with <code>julia&gt;</code> ).</p>
<p>Julia’s <code>CSV</code> package does a good job reading in many data formats, but it also wants to know what kind of object you will turn the data into (a matrix, a vector, a dataframe?). We’ll go for a DataFrame object:</p>
<div id="8" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span>, <span class="bu">DataFrames</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>buffalo_data <span class="op">=</span> CSV.<span class="fu">read</span>(<span class="st">"&lt;path to your repository&gt;/labs/data/buffalo_2021.txt"</span>,DataFrame,delim<span class="op">=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,missingstring<span class="op">=</span>NA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unlike <code>R</code>, if the package is not installed <code>Julia</code> will just ask if you would like to install it, and if you say yes, it will automatically load it after installation. Now that you have the data open, let’s take a look at it!</p>
</section>
<section id="re-creating-the-main-plot-in-buffalo-2021" class="level2">
<h2 class="anchored" data-anchor-id="re-creating-the-main-plot-in-buffalo-2021">Re-creating the main plot in Buffalo 2021</h2>
<p>Data exploration is often visual - it’s a good idea to see what the distribution of data looks like before you decide what statistical model to use on it. We’ll start with a relatively simple plot: a scatter plot of the population size vs genetic diversity. To do this you’ll need to figure out some basics of how to refer to different data columns in your language of choice. Code to plot this will be your first reportable bit for the lab. If you are already comfortable plotting data - great! Focus on the rest of the lab and skip ahead to</p>
</section>
<section id="plotting-in-r" class="level2">
<h2 class="anchored" data-anchor-id="plotting-in-r">Plotting in <code>R</code></h2>
<p>Start by checking the opened data. Just like bash, <code>R</code> also has a <code>head</code> command. If you run</p>
<div id="10" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(buffalo_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should see:</p>
<pre class="{output}"><code># A tibble: 6 × 60
  species             phylum habitat mating_system range_cat sexual_system abbrv
  &lt;chr&gt;               &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;         &lt;chr&gt;
1 Abatus agassizi     Echin… NA      NA            NA        NA            NA   
2 Acromyrmex echinat… Arthr… NA      NA            NA        male.haploid  NA   
3 Acropora millepora  Cnida… NA      NA            NA        hermaphrodite NA   
4 Acyrthosiphon pisum Arthr… Terres… Partial self… Cosmopol… parthenogenic NA   
5 Aedes aegypti       Arthr… Terres… Obligatory o… Cosmopol… gonochorous   NA   
6 Aedes albopictus    Arthr… NA      NA            NA        gonochorous   NA   </code></pre>
<p>Note a couple of things: the data contains 60 columns, the names of the first 8 of which are listed above. Under each name of column the data type is specified (in this case, all <code>chr</code> - character data, e.g.&nbsp;text strings). Not visible in this text, but hopefully in yours - the NA entries should be a different color, highlighting where data is missing.</p>
<p>You might want to know all of the different columns available: you can get that list by asking for the <code>names</code> of the data</p>
<div id="12" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(buffalo_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And you should see:</p>
<pre class="{output}"><code> [1] "species"               "phylum"                "habitat"              
 [4] "mating_system"         "range_cat"             "sexual_system"        
 [7] "abbrv"                 "neut_model_conf"       "genome_species"       
[10] "self_est"              "maplen_data_source"    "diversity_data_source"
[13] "site_type"             "hcn"                   "num_markers"          
[16] "parpath"               "pred_pi"               "impact_of_sel"        
[19] "log10_size"            "log10_range"           "num_chr"              
[22] "totalMb_covered"       "ave_rec"               "assembly_size"        
[25] "selfing"               "map_length"            "genome_size"          
[28] "fecundity"             "propagule"             "bodymass_g"           
[31] "diversity"             "size"                  "log10_diversity"      
[34] "social"                "species_orig"          "is_terrestrial"       
[37] "n_occ"                 "range"                 "id"                   
[40] "kingdom"               "superphylum"           "subphylum"            
[43] "class"                 "order"                 "family"               
[46] "genus"                 "clean_name"            "redlist_cat"          
[49] "log10_body_mass"       "log10_body_mass_pred"  "log10_popsize"        
[52] "log10_density"         "log10_density_pred"    "pred_log10_body_mass" 
[55] "pred_log10_density"    "pred_log10_N"          "RS"                   
[58] "log10_RS"              "log10_map_length"      "species_lower" </code></pre>
<p>For your plot, you’ll want to plot <code>pred_log10_N</code> against <code>log10_diversity</code>. Calling a column from a table is done as: <code>&lt;your data frame&gt;$&lt;your column_name&gt;</code>. So, to look at just the predicted log 10 population size, you might call <code>buffalo_data$pred_log10_N</code>.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
</div>
<div class="callout-body-container callout-body">
<p>Hitting the <code>Tab</code> key will automatically try to fill out the rest of a variable/function name in <code>R</code>, and will even give you an overview of arguments one could call. Don’t be shy about mashing the <code>Tab</code> key as you code, just to avoid any coding issues.</p>
</div>
</div>
<p><em>How</em> you plot is an exercise left to the reader. You can do a very basic plot with <code>R</code>s innate <code>plot</code> functions, but I would recommend taking the time to look at something like <code>ggplot2</code> (follow <a href="https://ggplot2.tidyverse.org/articles/ggplot2.html">this</a> guide, but just substitute your data in.)</p>
</section>
<section id="plotting-in-julia" class="level2">
<h2 class="anchored" data-anchor-id="plotting-in-julia">Plotting in <code>Julia</code></h2>
<p>Before we plot, let’s see how the code differs compared to <code>R</code>. Just like <code>R</code>, we can take a look at the head of the data, but that’s done by default when you import the data. So you should have already seen something like:</p>
<pre class="{julia-output}"><code>300×60 DataFrame
 Row │ species                      phylum         habitat      mating_system           range_cat       sexual_system  abbrv     neut_model_conf  genome_species  self_est  maplen_data_source  diversity_data_source  site_type  hc ⋯
     │ String                       String15       String31?    String31?               String15?       String31?      String7?  String3?         String31?       Float64?  String31?           String31?              Missing    In ⋯
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ Abatus agassizi              Echinodermata  missing      missing                 missing         missing        missing   missing          missing          missing  missing             Romiguier et al.         missing  mi ⋯
   2 │ Acromyrmex echinatior        Arthropoda     missing      missing                 missing         male.haploid   missing   missing          missing          missing  Stapley et al.      missing                  missing 
   3 │ Acropora millepora           Cnidaria       missing      missing                 missing         hermaphrodite  missing   missing          missing          missing  Stapley et al.      missing                  missing 
   4 │ Acyrthosiphon pisum          Arthropoda     Terrestrial  Partial selfing         Cosmopolitan    parthenogenic  missing   missing          missing          missing  Stapley et al.      Leffler et al.           missing 
   5 │ Aedes aegypti                Arthropoda     Terrestrial  Obligatory outcrossing  Cosmopolitan    gonochorous    missing   missing          missing          missing  Stapley et al.      Leffler et al.           missing     ⋯
   6 │ Aedes albopictus             Arthropoda     missing      missing                 missing         gonochorous    missing   missing          missing          missing  Stapley et al.      missing                  missing 
   7 │ Agelaius phoeniceus          Chordata       Terrestrial  Obligatory outcrossing  Broad endemic   missing        missing   missing          missing          missing  missing             Leffler et al.           missing  mi
   8 │ Ailuropoda melanoleuca       Chordata       Terrestrial  Obligatory outcrossing  Narrow endemic  missing        missing   missing          missing          missing  missing             Leffler et al.           missing  mi
  ⋮  │              ⋮                     ⋮             ⋮                 ⋮                   ⋮               ⋮           ⋮             ⋮               ⋮            ⋮              ⋮                     ⋮                ⋮         ⋱
 294 │ Tupaia belangeri             Chordata       Terrestrial  Obligatory outcrossing  Broad endemic   missing        missing   missing          missing          missing  missing             Leffler et al.           missing  mi ⋯
 295 │ Varecia variegata            Chordata       missing      missing                 missing         missing        missing   missing          missing          missing  missing             Romiguier et al.         missing  mi
 296 │ Varecia variegata variegata  Chordata       Terrestrial  Obligatory outcrossing  Island          missing        missing   missing          missing          missing  missing             Leffler et al.           missing  mi
 297 │ Vespula vulgaris             Arthropoda     missing      missing                 missing         male.haploid   missing   missing          missing          missing  Stapley et al.      missing                  missing 
 298 │ Xenopus tropicalis           Chordata       missing      missing                 missing         gonochorous    missing   missing          missing          missing  Stapley et al.      missing                  missing     ⋯
 299 │ Xiphophorus maculatus        Chordata       missing      missing                 missing         gonochorous    missing   missing          missing          missing  Stapley et al.      missing                  missing 
 300 │ Zonotrichia albicollis       Chordata       Terrestrial  Obligatory outcrossing  Broad endemic   missing        missing   missing          missing          missing  missing             Leffler et al.           missing  mi
                                                                                                                                                                                                       47 columns and 285 rows omitte</code></pre>
<p>A couple worthwile notes - <code>Julia</code> recoded the NAs as <code>missing</code>, which is a special type in <code>Julia</code>, and will give you headaches sometimes. Second, to save on memory, it has used the minimal size of String as the <code>type</code> for each column. For instance, no Phylum is longer than 15 characters, so it uses the String15 type, which has no more than 15 characters. These tiny optimizations add up to one of the reasons <code>Julia</code> performs much faster than <code>R</code> for big projects.</p>
<p>Julia has a bunch of approaches to plotting, probably more than either <code>R</code> or <code>python</code>, as there’s lots of different subfields with their own plotting approaches. My goal is for you to write scripts <em>you</em> like using, so I’ll recommend taking a look at the plotting backends <a href="https://docs.juliaplots.org/dev/backends/">most are listed here</a> except for the <code>Makie</code> ecosystem, which you can take a glance at [here] . Overall - <code>Plots.jl</code> is a fine starting point, but <code>Makie</code> is popular because it allows some more fine-tuned customization for the plots. If you are working on a cluster, absolutely check out <code>UnicodePlots.jl</code>, as it can spit out nice summary plots without you having to download them/run interactive sessions.</p>
<p>The syntax to get a particular column in <code>Julia</code> is <code>&lt;data_frame&gt;.&lt;column_name&gt;</code>, so to get the population size you’d write <code>buffalo_data.pred_log10_N</code>. Now, follow the guide for your chosen plotting package and plot <code>N</code> versus <code>diversity</code>.</p>
</section>
</section>
<section id="genomic-data-formats" class="level1">
<h1>Genomic data formats</h1>
<p>As with any recent field, the proliferation of data has also meant a giant proliferation of data formats for genomic data. All of this is because of, generally, good intentions:</p>
<p><img src="images/paste-2.png" class="img-fluid"></p>
<p>The format we’ll focus on working with has <em>mostly</em> won out the fight for being <em>the</em> standard for genomic data: VCF (Variant Call Format). If you want the nitty gritty <a href="https://samtools.github.io/hts-specs/VCFv4.2.pdf">here</a> is the standard description, with way too many details. Below is a shorter summary.</p>
<section id="how-is-a-vcf-file-structured" class="level2">
<h2 class="anchored" data-anchor-id="how-is-a-vcf-file-structured">How is a VCF file structured</h2>
<section id="headers" class="level3">
<h3 class="anchored" data-anchor-id="headers">Header(s)</h3>
<p>VCF files start with a whole bunch of lines starting with <code>##</code>. Some of these lines are mandatory, such as the first one which says which <em>version</em> of the VCF format is being used. Others are useful for good science, like keeping track of the commands that were used to generate this particular VCF. Additionally, there are many lines which determine what kind of details about the genotype calss are contained in the file. For today, we won’t worry about almost all of them, as the file I’ll have you play with is as basic as possible.</p>
<p>The final line before the data <em>actually</em> starts only has a single <code>#</code>, and is the real header. This has the names of each data column, including eight fixed fields:</p>
<pre><code>#CHROM   POS   ID    REF    ALT    QUAL    FILTER    INFO    FORMAT</code></pre>
<p>These are: the chromosome the variant is on, its position, a unique ID, what allele is present in the reference, what alterante allele(s) are found in the data, the quality of the call as a [PHRED]() score, whether the site is filtered out or not, and an INFO column that can contain a lot of information about how the allele, and a FORMAT tab that tells you how the genotypes are listed. Generally, this will start with <code>GT</code>, and can then have various bits after a <code>:</code>, like <code>GT:GQ</code> means that you will first see the genotype, and then the genotype quality. The rest of the header is a list of your individual samples:</p>
<pre><code>#CHROM   POS   ID    REF    ALT    QUAL    FILTER    INFO   
FORMAT    Ind1     Ind2     Ind3   .... IndN</code></pre>
</section>
</section>
<section id="genotype-information" class="level2">
<h2 class="anchored" data-anchor-id="genotype-information">Genotype information</h2>
<p>After this, the file is a list of sites, each of which starts with the 8 fixed columns of info, and then presents the genotype for each individual. They look something like:</p>
<pre><code>#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  HG00096 HG00092
10   60523  rs148087467    T     G       100     PASS    -      GT:GL    0|0:-0.19  0/1:-0.12</code></pre>
<p>What does this say? Well, individuals <code>HG00096</code> and <code>HG00092</code> have two different genotypes: <code>0|0</code> and <code>0/1</code> . A pipe character <code>|</code> means that the data is phased (we’ll talk about this next week), while the <code>0/1</code> says that the data is unphased. <code>0</code>s indicate the reference allele (T, in this case), while 1 indicates the first ALT allele (G, in this case). You could also see something like:</p>
<pre><code>#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  HG00096 HG00092
8   11200  -    T     G,C,A       100     PASS    -      GT    1|2    0/3</code></pre>
<p>This tells you the individuals have genotypes: GC and TA, respectively.</p>
</section>
<section id="reading-in-vcf-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-in-vcf-data">Reading in VCF data</h2>
<p>There are many genomics packages in <code>R</code>, and so there are many ways to read in a VCF. Today, I’ll have you try the <code>vcfR</code> package: [link](<a href="https://cran.r-project.org/web/packages/vcfR/index.html" class="uri">https://cran.r-project.org/web/packages/vcfR/index.html</a>), which is fairly minimal. Once you have the package installed and loaded, find the .vcf file in the `labs/data` folder of the repository, and read it in. Because in practice you’ll often work with the genotype matrix, I’ve gone ahead and added a line that converts the vcf to a genotype matrix:</p>
<div id="14" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(vcfR)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>vcf <span class="op">=</span> read.<span class="fu">vcfR</span>(<span class="st">"&lt;path to file&gt;"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>GT <span class="op">=</span> extract.<span class="fu">gt</span>(vcf,element<span class="op">=</span><span class="st">"GT"</span>,as.numeric<span class="op">=</span>TRUE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The file I’ve constructed is extremely minimal, in that it only contains genotype data. The goal today is to write a function that can calculate the per-site heterozygosity of the data. I have a scaffold of a function set up below, but I want you to play around with the data and find what works for you to actually extract the information.</p>
<div id="16" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>h_vcf <span class="op">=</span> <span class="kw">function</span>(gt_matrix){</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    h_s <span class="op">=</span> <span class="fu">apply</span>(gt_matrix,<span class="fl">1</span>,h_sample) <span class="co"># Apply takes a matrix (gt_matrix here), an argument specifying whether it should run across each row (1) or column(2) or entry(1:2), and a function to apply to that row/column. </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(<span class="fu">sum</span>(h_s)<span class="op">/</span><span class="fu">dim</span>(gt_matrix)[<span class="fl">1</span>]) <span class="co">#h_s will be heterozygosities at each site, so we take their average.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>h_sample <span class="op">=</span> <span class="kw">function</span>(site){</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The above function makes sure you get passed an array of values, where 0 is aa, 1 is Aa and 2 is AA. How do we go from that to sample heterozygosity? </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Take a look at the lecture notes. Remember that you need to account for how many sites are actually sampled.</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    allele_frequency <span class="op">=</span> ???</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> ???</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> ???</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(h)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="julia-solution" class="level2">
<h2 class="anchored" data-anchor-id="julia-solution">Julia solution</h2>
<p>You’ve already been given some code to calculate h_sample given a vector in class, so I’ll instead ask you to calculate the Site Frequency Spectrum. Of course, feel free to work out by yourself how you would calculate <code>h</code> (the two are very closely linked). In <code>Julia</code>, the best package to deal with <code>vcf</code> files is <code>VCFTools</code>. Unlike <code>vcfR</code>, it will not try to read in and keep the whole vcf in memory. Rather, it has many utility functions to quickly allow you to read in only the data you are interested in. So, to get out the genotype matrix, you would run:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">VCFTools</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>gt_matrix <span class="op">=</span> <span class="fu">convert_gt</span>(<span class="dt">Int8</span>,<span class="st">"&lt;path to vcf&gt;"</span>;model<span class="op">=:</span>additive,impute<span class="op">=</span><span class="cn">false</span>,scale<span class="op">=</span><span class="cn">false</span>,center<span class="op">=</span><span class="cn">false</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that because <code>Julia</code> is often column centric, each individual is a row, and each column is now a variant, unlike the VCF. Now, to calculate the SFS, you’ll want to map a function that calculates frequency across the data.</p>
<div id="20" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">frequency</span>(site)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    freq <span class="op">=</span> <span class="cn">missing</span> <span class="co">#Think about how you'd get allele frequencies from a genotype matrix. How do you account for missing data?</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(freq)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>sitefreqs <span class="op">=</span> [<span class="fu">frequency</span>(i) for i <span class="kw">in</span> <span class="fu">eachcol</span>(gt_matrix)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bonus-plot-your-heterozygosities" class="level2">
<h2 class="anchored" data-anchor-id="bonus-plot-your-heterozygosities">Bonus: Plot your heterozygosities</h2>
<p>Now that you have hopefully learned both how to plot data, and how to calculate heterozygosity (or the SFS), try to plot your data. As you do so, keep track of what bits of code you keep re-running/re-using. Could you have written your code in a way that made those bits modular? (e.g.: functions that are called, so that you only need to maintain one copy of the function).</p>
</section>
</section>
<section id="why-do-i-need-to-write-my-own-code-for-heterozygosity-isnt-there-software-for-this" class="level1">
<h1>Why do I need to write my own code for heterozygosity? Isn’t there software for this?</h1>
<p>Absolutely! The problem is that different software packages make different assumptions/concessions when it comes to any population genetic analyses. In general, for any publication I would recommend using a well vetted external package for your final version, but I would also try to verify at least some of the analysis with your own code. For instance, if you use something like <code>vcftools --het</code> to calculate heterozygosity, it will <em>skip</em> any sites with missing data entirely, and also assume that any site <em>not</em> in the VCF is the reference allele (e.g.&nbsp;het==0). That means that it often under-estimates heterozygosity, especially when there is a lot of missing data. On the other hand, something like <code>pixy</code> (<a href="https://github.com/ksamuk/pixy">link</a>) will do a much more thorough job (although see <span class="citation" data-cites="konopinski2022">(<a href="#ref-konopinski2022" role="doc-biblioref">Konopiński 2022</a>)</span>), but requires you to prepare your vcf files in a specific way. <code>ANGSD</code> is a fairly good method, but requires you to convert your VCFs into <code>PLINK</code> input files (<code>.bed .bim .fam</code>). The estimates often don’t <em>exactly</em> agree, and so it’s good to understand what goes into coding <em>any</em> estimator, let alone a more robust one as implemented in many popular packages. The good news: SNP based estimates are probably robust <span class="citation" data-cites="miller2013">(<a href="#ref-miller2013" role="doc-biblioref">Miller et al. 2013</a>)</span>, but keep in mind how these approaches work. To compare with what you obtained, try to run the following approaches:</p>
<p>1) <code>diversity.stats</code> from the <code>PopGenome</code> library in <code>R</code>: <a href="https://popgenome.weebly.com/">link</a></p>
<p>2) <code>vftools labs/data/test_data.vcf.gz --het</code> You can do this on the HPC if you have access, or just install <code>vcftools</code> locally: <a href="https://vcftools.github.io/index.html">link</a>. This is optional - if you have trouble setting up vcftools on your machine, don’t worry about this for the moment, but I’m happy to help you get set-up.</p>
<p>3) <code>nucleotideDiversity</code> from <code>strataG</code> in <code>R</code>. You’ll need to convert the vcf to a <code>genlight</code> object, good luck!</p>
<p>You will probably find that each gives a subtly different answer - that is why population genomics studies are more and more persnickety about you specifying <em>exactly</em> what you did and how you got your results, as each pipeline is bespoke and has unique flaws that no others do.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Buffalo2021" class="csl-entry" role="listitem">
Buffalo, Vince. 2021. <span>“Quantifying the Relationship Between Genetic Diversity and Population Size Suggests Natural Selection Cannot Explain Lewontin<span>’</span>s Paradox.”</span> <em>eLife</em> 10 (August). <a href="https://doi.org/10.7554/elife.67509">https://doi.org/10.7554/elife.67509</a>.
</div>
<div id="ref-konopinski2022" class="csl-entry" role="listitem">
Konopiński, Maciej K. 2022. <span>“Average Weighted Nucleotide Diversity Is More Precise Than Pixy in Estimating the True Value of <span><em>π</em></span> from Sequence Sets Containing Missing Data.”</span> <em>Molecular Ecology Resources</em> 23 (2): 348–54. <a href="https://doi.org/10.1111/1755-0998.13707">https://doi.org/10.1111/1755-0998.13707</a>.
</div>
<div id="ref-miller2013" class="csl-entry" role="listitem">
Miller, J M, R M Malenfant, P David, C S Davis, J Poissant, J T Hogg, M Festa-Bianchet, and D W Coltman. 2013. <span>“Estimating Genome-Wide Heterozygosity: Effects of Demographic History and Marker Type.”</span> <em>Heredity</em> 112 (3): 240–47. <a href="https://doi.org/10.1038/hdy.2013.99">https://doi.org/10.1038/hdy.2013.99</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/adagilis\.github\.io\/PopGen25\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>